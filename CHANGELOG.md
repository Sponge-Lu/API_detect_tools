# 更新日志

所有对本项目的显著变更都将记录在此文件中。

格式基于 [Keep a Changelog](https://keepachangelog.com/en/1.0.0/)，并且本项目遵循 [Semantic Versioning](https://semver.org/spec/v2.0.0.html)。

## [v2.1.7]

### 新增
- **Gemini CLI 配置支持**：完整支持 Gemini CLI 配置生成和应用
  - Gemini CLI 默认启用
  - 支持生成 settings.json 和 .env 配置文件
  - 配置模板参考 `docs/cli_config_template/gemini_cli_config_template.md`
- **配置合并模式**：应用配置时支持合并和覆盖两种模式
  - 合并模式（默认）：保留现有配置，只更新相关项
  - 覆盖模式：完全替换现有配置文件
  - JSON 文件：深度合并，保留现有配置项
  - TOML 文件：合并顶级变量和 sections
  - .env 文件：只更新相关环境变量，保留其他变量
  - 避免覆盖用户的 MCP 服务器配置等自定义设置
- **配置重置功能**：配置预览区域新增"重置"按钮
  - 点击后弹出确认对话框，确认后恢复为默认生成的配置
  - 仅在有编辑内容时显示
- **统一 CLI 配置对话框**：合并原有的 CLI 配置和配置生成功能
  - CLI 开关区域：所有 CLI 类型在同一行显示，支持独立启用/禁用
  - 模型分离：测试使用模型和 CLI 使用模型分开配置
  - 实时配置预览：选择 API Key 和模型后自动生成配置，支持编辑
  - 配置模板：未选择配置时显示完整模板内容供参考
  - 代理设置：Claude Code 配置自动包含 HTTPS_PROXY 和 HTTP_PROXY
- **应用配置功能**：一键将配置写入本地文件
  - 应用弹出菜单：显示已配置的 CLI 列表（包括 Gemini CLI）
  - 配置文件写入：自动创建目录并写入配置文件
  - Claude Code 重启提醒：应用配置后提示用户重启 IDE

### 变更
- 移除 Chat 基础测试功能及相关代码
- Gemini CLI 从默认禁用改为默认启用

### 优化
- 移除独立的配置生成对话框，功能整合到统一配置对话框
- 配置预览窗口移除固定高度限制，显示完整内容

---

## [v2.1.6]

### 新增
- **CLI 兼容性测试**：检测站点是否支持 Claude Code、Codex、Gemini CLI 等工具
  - 支持单站点测试（需先配置 CLI 设置）
  - 站点卡片显示 CLI 兼容性图标（彩色=支持，深灰=不支持，浅灰=已配置待测试，非常淡=未配置）
  - 鼠标悬停显示详细状态和上次测试时间
  - 测试结果持久化保存，重启应用后自动恢复
- **CLI 配置对话框**：为每个站点配置 CLI 测试参数
  - 选择用于测试的 API Key
  - 选择用于测试的模型（Claude Code 只显示 claude* 模型，Codex 只显示 gpt* 模型，Gemini CLI 只显示 gemini* 模型）
  - 支持 Claude Code、Codex、Gemini CLI 三种类型
- **CLI 官方图标**：使用 lobehub.com/icons 官方 SVG 图标
  - Claude Code（Anthropic 官方 logo）
  - Codex（OpenAI 官方 logo，绿色）
  - Gemini CLI（Google Gemini 官方 logo）

### 修复
- **CLI 配置加载**：修复应用重启后 CLI 配置和测试结果不显示的问题
  - 兼容 `cached_data` 和站点根级别两种数据存储位置

---

## [v2.1.5]

### 优化
- **日志统计过滤**：今日消费、Token 使用量和请求次数统计现在只包含模型调用日志，排除系统日志和管理操作日志，统计数据更准确
- **"真·空数据"刷新提示**：与其他刷新操作保持一致，显示"数据已更新"或"数据无变化"，移除 toast 弹窗

### 新增
- **站点列表排序功能**：
  - 点击表头列标题可按该列排序（站点名、余额、今日消费、Token、请求数、RPM、TPM、模型数、更新时间）
  - 首次点击降序，再次点击升序，第三次点击取消排序
  - 当前排序列显示箭头图标（↓降序/↑升序）
  - 排序设置自动保存到 config.json，重启应用后自动恢复

### 优化
- **签到/加油站图标**：移除按钮文字，仅显示图标，界面更简洁
- **数值列颜色区分**：总Token、输入、输出、请求、RPM、TPM 列，值为0时颜色更淡，不为0时颜色加深

### 变更
- **站点状态显示优化**：状态列合并到站点名称前
  - 绿色圆点（带脉冲动画）= 在线
  - 红色圆点 = 离线
  - 灰色圆点 = 未检测
  - 错误码/超时紧凑显示在名称后
- **自动刷新改为站点独立控制**：
  - 从全局设置移除自动刷新选项
  - 每个站点有独立的自动刷新开关（Timer 图标）
  - 状态保存在站点配置中，持久化到 config.json
- **自动刷新间隔设置**：
  - 在站点编辑器中配置自动刷新开关和刷新间隔（最小 3 分钟）
  - 站点卡片上的刷新按钮可快速切换开关状态
  - 间隔时间持久化保存到站点配置
- **自动刷新定时器实现**：
  - 新增 `useAutoRefresh` hook 管理站点自动刷新定时器
  - 支持多站点并发刷新，互不干扰
  - 定时器在站点配置变更时自动更新（启用/禁用/间隔变化）
  - 组件卸载时自动清理所有定时器
- **Cloudflare 保护站点支持**：
  - 站点编辑器中提醒用户 CF 保护站点需保持浏览器开启
  - 有站点开启自动刷新时，检测完成后不自动关闭浏览器
- **移除禁用/启用按钮**：从站点操作中移除

### 优化
- **今日消费颜色**：消费为 0 时使用更浅的橙色，便于区分
- **列宽配置**：从 12 列减为 11 列，站点列宽增加以容纳状态图标
- **并发刷新结果更新**：修复多站点同时刷新时结果互相覆盖的问题

---

## [v2.1.4]

### 新增
- **"真·空数据"功能**：认证错误弹窗新增"真·空数据"按钮
  - 适用场景：站点管理员清空了模型列表，但 Token 仍然有效
  - 点击后强制获取数据（接受空数组），直接更新结果
  - 弹窗内提供"打开站点"链接，方便用户先确认数据状态再选择操作

### 优化
- **认证错误诊断**：改进认证错误处理，精确区分三种不同的认证问题
  - ⏰ 会话过期：返回成功但无数据时（Token 有效，Session 失效）
  - 🔑 Token 失效：返回 401 状态码时
  - 🚫 权限不足：返回 403 状态码时
- **错误提示优化**：认证错误对话框现在根据错误类型提供精确诊断和解决建议
- **批量检测体验**：认证错误不再阻塞检测流程
  - 移除检测到认证错误时立即弹窗的逻辑
  - 所有站点检测完成后统一提醒需要重新登录的站点
  - Cloudflare 浏览器模式正常工作，不受影响

### 修复
- **Turnstile 签到失败无弹窗**：修复签到返回"Turnstile token 为空"时未触发手动签到弹窗的问题
- **站点认证弹窗循环问题**：修复重新获取站点信息后仍然弹窗"站点认证需要更新"的问题
  - 移除"检测到会话过期时立即停止尝试其他端点"的错误优化
  - 所有端点都会被完整尝试，综合判断结果
  - 空数组响应（`{ success: true, data: [] }`）正确识别为 session 过期
  - 优先处理空响应，确保触发正确的认证错误弹窗
- **浏览器未关闭**：修复重新获取站点信息后浏览器窗口未自动关闭的问题
  - 站点初始化完成后（无论成功或失败）自动关闭浏览器
  - 编辑站点保存后自动刷新完成后也会尝试关闭浏览器
  - 使用安全的 `cleanup()` 方法，检查引用计数避免误关正在进行其他检测的浏览器
- **配置保存时序**：修复编辑站点保存后自动检测使用旧配置的问题
  - 添加 `await` 确保配置保存完成后再开始检测
  - 避免检测时使用过期的 access_token 导致认证错误
- **TLS 握手失败**：修复打包后某些站点（如 anyrouter.top）出现 `SSLV3_ALERT_HANDSHAKE_FAILURE` 错误的问题
  - 根因：Electron 打包后使用 BoringSSL（Chrome 的 SSL 库），支持的加密套件比开发环境的 OpenSSL 更少
  - 解决方案：创建统一 HTTP 客户端，打包环境自动使用 Electron `net` 模块（Chromium 网络栈）替代 axios
  - 新增 `src/main/utils/electron-fetch.ts` - Electron net 模块封装
  - 新增 `src/main/utils/http-client.ts` - 统一 HTTP 客户端（自动切换）

---

## [v2.1.3]

### 新增
- **软件更新检测**：支持在应用内检查软件更新
  - 启动时自动在后台检查更新（可在设置中关闭）
  - 手动检查更新功能
  - 同时显示最新正式版本和预发布版本
  - 预发布版本支持（Beta、Alpha 等）
  - 更新详情对话框，显示版本号、发布日期、更新说明
  - 一键跳转到下载页面
  - Header 区域显示更新提示徽章

### 修复
- **配置导出**：修复导出配置时加油站链接和签到信息字段可能缺失的问题
- **浏览器管理**：修复所有站点检测完成后浏览器未及时关闭的问题
  - 新增 `forceCleanup` 方法强制关闭浏览器，忽略引用计数
  - 检测完成后自动调用强制关闭
- **页面管理**：修复同一站点可能打开多个重复页面的问题
  - 改进页面清理逻辑，自动关闭同一域名的重复页面

---

## [v2.1.2]

### 新增
- **WebDAV 云端备份**：支持将配置备份到 WebDAV 云存储（坚果云、NextCloud、Synology NAS 等）
  - 配置 WebDAV 连接（服务器地址、用户名、密码、远程路径）
  - 连接测试功能
  - 上传备份（自动生成带时间戳的文件名）
  - 查看和管理云端备份列表
  - 从云端备份恢复配置
  - 自动清理旧备份（可配置最大备份数量）

### 修复
- 修复检测所有站点完成后按钮仍显示"检测中"的问题
- 修复 WebDAV 配置在进行其他操作（如拖拽站点）后丢失的问题

### 优化
- 优化夜晚模式下设置面板各区域的视觉区分度
- 优化夜晚模式下站点一级卡片与二级面板的对比度

---

## [v2.1.1]

### 新增
- **模型列表分页显示**：默认只显示前 50 个模型，点击"显示全部"加载更多，大幅提升展开全部站点时的渲染性能。
- **批量检测实时刷新**：并发检测时单站完成即刻更新 UI，不再等待全部结束。
- **UI优化**：表头使用和站点卡片一致的渐变色；用户分组图标改为按顺序显示的圆框数字（①②③...）。
- **登录提示与等待**：批量检测遇到未登录站点时，自动打开浏览器并弹窗提示用户登录，登录后可继续检测。
- **证书错误提示**：模型/余额接口遇到证书过期或不受信任（如 “Certificate has expired”）时，直接提示原因，避免长时间超时。
- **模型全局搜索栏**：全局搜索模型，隐藏没有该模型的站点。
- **UI调整**：站点一级卡片增加渐变色，在展开二级面板后更显眼；白天模式的签到标签文字对比度增加；夜晚模式下，最大并发数可以看到了。
- **全部站点展开/收起**：可以对所有站点卡片同时展开与收起，避免一个一个手动点击。
- **签到按钮自动恢复**：第二天签到按钮自动恢复成”签到“样式。

### 默认调整
- 超时默认 30 秒。
- 并发默认开启，最大并发默认 3（可在设置中调节 1–5）。

### 其他
- 调试端口随机化，减少固定端口被拦截/误报的概率。
- 取消隐藏/后台启动 Chrome，降低被杀软误报概率。

---

## [2.1.0] - 2025-12-02

### 新增
- **架构重构**：全面迁移至 Zustand 状态管理，降低组件耦合度，提升应用响应速度。
- **模块化服务**：拆分 IPC 处理器为独立的模块（config, theme, backup, token, detection），主进程逻辑更清晰。
- **自动备份系统**：配置文件和令牌数据自动备份到 `~/.api-hub-management-tools/`，并提供 GUI 界面支持从任意历史备份恢复。
- **备份恢复体验**：从备份恢复配置后立即加载数据，无需重启应用。
- **更新时间显示**：优化站点更新时间的显示逻辑，使用更人性化的格式（如“x天前”）。
- **配置导入导出**：支持 JSON 格式的完整配置导入导出，便于数据迁移。
- **Toast 通知**：引入全局 Toast 通知系统，提供更友好的操作反馈。
- **加载骨架屏**：在数据加载时显示骨架屏，提升视觉体验。

### 优化
- **性能提升**：引入 `RequestManager` 实现 API 请求去重与缓存，减少不必要的网络请求。
- **构建体积**：优化 Vite 配置与代码分割，显著减小应用体积。
- **错误处理**：统一了全链路的错误捕获与提示机制，确保异常情况有明确反馈。
- **代码规范**：落地 ESLint + Prettier + Husky 工作流，统一代码风格。
- **类型安全**：引入 Zod 进行运行时输入验证，强化 TypeScript 类型定义。

### 修复
- 修复了主进程中重复注册 IPC 处理器的问题。
- 修复了部分 API 请求头重复定义的问题。
- 移除了大量废弃的旧代码（如 ConfigManager, TokenStorage），精简代码库。

---

## [2.0.6] - [2.0.8]
- **忘记记录了**

---

## [2.0.5] - 2025-11-27

### 优化
- **智能添加站点**：简化添加流程，从 4 步减少为 2 步。点击“获取信息”后自动处理浏览器登录与检测。
- **状态反馈**：添加站点时实时显示操作状态（启动浏览器、等待 Cloudflare、等待登录等）。
- **登录检测**：增强了 Session 过期检测和页面导航重试机制。
- **界面布局**：优化站点编辑卡片，采用更紧凑的布局，提升信息密度。
- **签到体验**：签到失败后支持直接跳转到签到页面；优化了相关提示文案。

---

## [2.0.4] - 2025-11-26

### 新增
- **自定义弹窗**：使用美观的自定义弹窗替代系统原生 alert/confirm。
- **分组排序**：支持通过拖拽调整站点分组的顺序。
- **主题持久化**：修复了重启后主题设置丢失的问题，并解决了启动白屏闪烁。

### 优化
- **界面细节**：调整了字体大小和间距，提升整体可读性。
- **权限错误提示**：检测到 401/403 错误时，提供更明确的重新登录引导。
- **浏览器管理**：优化了会话清理逻辑，防止加载旧的历史页面。

---

## [2.0.3] - 2025-11-25

### 新增
- **站点分组管理**：支持创建、编辑、删除站点分组。
- **分组筛选**：支持按分组筛选站点列表。
- **拖拽分组**：支持将站点拖拽到分组标签进行快速分类。

### 修复
- 修复了配置文件加载时的部分逻辑错误。

---

## [2.0.2] - 2025-11-24

### 新增
- **API Key 管理增强**：支持在应用内直接删除 API Key，并兼容多种删除接口格式。
- **Cloudflare 兼容**：API Key 操作支持自动降级到浏览器模式，以绕过 Cloudflare 验证。

### 优化
- **刷新策略**：API Key 变更后仅刷新相关数据，不再强制全站刷新。

---

## [2.0.1] - 2025-11-20

### 新增
- **统计视图**：新增 Token 使用量（输入/输出/总量）、请求数、RPM/TPM 等统计指标。
- **列宽调整**：支持拖拽调整列表列宽，并自动保存偏好。
- **快捷操作**：在列表项中集成签到、复制、刷新等快捷按钮。

### 优化
- **信息展示**：优化了 API Key 和模型列表的展示布局，支持单行显示更多信息。
- **窗口适配**：调整默认窗口大小以适应新的宽布局。

---

## [2.0.0] - 2025-10-28

### 重大变更
- **浏览器启动重构**：使用 `spawn` 替代 `exec` 启动 Chrome，支持多路径自动检测，显著提升稳定性。
- **应用体积优化**：通过限制语言包、启用 ASAR 压缩和构建优化，体积减少约 60%。
- **生产环境修复**：修复了打包后出现的白屏问题。

### 新增
- **签到功能**：完整实现智能签到检测、一键签到及奖励显示。
- **加油站**：支持配置额外的福利链接。

---

## [1.x] - 历史版本

### 核心功能
- 支持 7 种主流 API 站点类型（New API, One API, Veloera 等）。
- 支持多账号管理、余额查看、模型列表。
- 支持 API Key 管理。
- 支持自动识别和手动添加站点。
